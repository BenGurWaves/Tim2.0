<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üêª Tim v2.1</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:-apple-system,BlinkMacSystemFont,sans-serif; }
body { display:grid; grid-template-columns:280px 1fr 320px; height:100vh; background:#0a0a0a; color:#fff; overflow:hidden; }

/* MOBILE HAMBURGER */
.hamburger { display:none; position:fixed; top:15px; left:15px; z-index:200; width:40px; height:40px; background:#222; border-radius:8px; cursor:pointer; justify-content:center; align-items:center; }
.hamburger-right { left:auto; right:15px; }
.hamburger div { width:24px; height:3px; background:#fff; margin:4px 0; }

/* LEFT SIDEBAR */
.left-sidebar { background:#1a1a1a; padding:20px; overflow-y:auto; border-right:1px solid #333; }
.logo { font-size:20px; font-weight:700; margin-bottom:25px; }
.status-box { background:#222; padding:15px; border-radius:8px; margin-bottom:20px; cursor:pointer; }
.status-box:hover { background:#2a2a2a; }
.status-dot { display:inline-block; width:10px; height:10px; background:#0f0; border-radius:50%; margin-right:8px; animation:pulse 2s infinite; }
@keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.3; } }
.info-row { display:flex; justify-content:space-between; margin:8px 0; font-size:13px; }
.info-label { color:#888; }
.info-value { color:#fff; font-weight:600; cursor:pointer; }
.info-value:hover { color:#0066ff; }
.section { margin-top:25px; }
.section-title { font-size:14px; font-weight:600; color:#888; margin-bottom:10px; text-transform:uppercase; }
.section-item { padding:10px; background:#222; border-radius:6px; margin-bottom:8px; cursor:pointer; font-size:14px; }
.section-item:hover { background:#2a2a2a; }
.section-item.active { background:#0066ff; }
.add-btn { padding:10px; border:2px dashed #444; border-radius:6px; text-align:center; cursor:pointer; color:#888; margin-top:8px; font-size:13px; }
.add-btn:hover { border-color:#0066ff; color:#0066ff; }
.force-stop { margin-top:30px; padding:12px; background:#ff3333; border-radius:8px; text-align:center; cursor:pointer; font-weight:600; }
.force-stop:hover { background:#ff0000; }

/* CENTER AREA */
.center { display:flex; flex-direction:column; background:#0f0f0f; }
.chat-header { padding:15px 20px; background:#1a1a1a; border-bottom:1px solid #333; font-size:16px; font-weight:600; }
.chat-area { flex:1; padding:20px; overflow-y:auto; }
.message { padding:12px 16px; margin:10px 0; border-radius:12px; max-width:75%; font-size:14px; line-height:1.6; word-wrap:break-word; }
.message.user { background:#0066ff; margin-left:auto; }
.message.tim { background:#222; }
.input-area { padding:15px; background:#1a1a1a; border-top:1px solid #333; display:flex; gap:10px; }
.input-area input { flex:1; padding:12px 16px; background:#222; border:1px solid #444; border-radius:20px; color:#fff; outline:none; font-size:14px; }
.input-area button { padding:12px 24px; background:#0066ff; border:none; border-radius:20px; color:#fff; cursor:pointer; font-weight:600; }
.input-area button:hover { background:#0052cc; }

/* RIGHT SIDEBAR */
.right-sidebar { background:#1a1a1a; padding:20px; overflow-y:auto; border-left:1px solid #333; }
.pipeline-section { margin-bottom:20px; }
.pipeline-title { font-size:13px; font-weight:600; color:#888; margin-bottom:10px; text-transform:uppercase; }
.task-item { padding:12px; background:#222; border-radius:6px; margin-bottom:8px; font-size:13px; cursor:pointer; }
.task-item:hover { background:#2a2a2a; }

/* MODALS */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; justify-content:center; align-items:center; }
.modal.show { display:flex; }
.modal-content { background:#1a1a1a; padding:30px; border-radius:12px; max-width:600px; width:90%; max-height:80%; overflow-y:auto; }
.modal-header { font-size:18px; font-weight:700; margin-bottom:20px; }
.modal-input { width:100%; padding:12px; background:#222; border:1px solid #444; border-radius:8px; color:#fff; margin-bottom:15px; font-size:14px; }
.modal-textarea { width:100%; min-height:150px; padding:12px; background:#222; border:1px solid #444; border-radius:8px; color:#fff; margin-bottom:15px; font-size:14px; resize:vertical; }
.modal-select { width:100%; padding:12px; background:#222; border:1px solid #444; border-radius:8px; color:#fff; margin-bottom:15px; font-size:14px; }
.modal-buttons { display:flex; gap:10px; justify-content:flex-end; margin-top:20px; }
.modal-btn { padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:14px; }
.modal-btn.primary { background:#0066ff; color:#fff; }
.modal-btn.secondary { background:#333; color:#fff; }
.modal-btn.danger { background:#ff3333; color:#fff; }

/* MOBILE */
@media (max-width: 768px) {
  body { grid-template-columns:1fr; }
  .left-sidebar, .right-sidebar { 
    display:none; 
    position:fixed; 
    z-index:100; 
    width:85%; 
    height:100%; 
    top:0;
  }
  .left-sidebar.mobile-open { display:block; left:0; }
  .right-sidebar.mobile-open { display:block; right:0; }
  .hamburger { display:flex; }
  .input-area { padding:10px; }
  .input-area button { padding:10px 16px; }
}
</style>
</head><body>

<!-- MOBILE HAMBURGERS -->
<div class="hamburger" onclick="toggleSidebar('left')">
  <div></div><div></div><div></div>
</div>
<div class="hamburger hamburger-right" onclick="toggleSidebar('right')">
  <div></div><div></div><div></div>
</div>

<!-- LEFT SIDEBAR -->
<div class="left-sidebar" id="leftSidebar">
  <div class="logo">üêª Tim v2.1</div>
  
  <div class="status-box" onclick="showStatusDetails()">
    <div><span class="status-dot"></span><span id="status-text">Idle</span></div>
    <div class="info-row"><span class="info-label">Details:</span><span id="status-details">Ready</span></div>
  </div>
  
  <div class="info-row">
    <span class="info-label">Model:</span>
    <span class="info-value" id="model-name" onclick="showModelSwitcher()">qwen3:30b</span>
  </div>
  <div class="info-row">
    <span class="info-label">Skills:</span>
    <span class="info-value" id="skills-count" onclick="showSkills()">8</span>
  </div>
  
  <div class="section" id="chats-section">
    <div class="section-title">Chats</div>
    <div class="add-btn" onclick="showAddChat()">+ Add Custom Chat</div>
  </div>
  
  <div class="section" id="projects-section">
    <div class="section-title">Projects</div>
    <div class="add-btn" onclick="showAddProject('normal')">+ New Project</div>
  </div>
  
  <div class="section" id="limited-projects-section">
    <div class="section-title">Limited Projects</div>
    <div class="add-btn" onclick="showAddProject('limited')">+ New Limited Project</div>
  </div>
  
  <div class="section">
    <div class="section-title">Journal</div>
    <div class="section-item" onclick="showJournal()">üìñ Tim's Journal</div>
  </div>
  
  <div class="force-stop" onclick="showForceStopModal()">‚ö†Ô∏è Force Stop</div>
</div>

<!-- CENTER -->
<div class="center">
  <div class="chat-header" id="chat-header">Main Chat</div>
  <div class="chat-area" id="chat-area"></div>
  <div class="input-area">
    <input type="text" id="msg-input" placeholder="Message Tim..." />
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<!-- RIGHT SIDEBAR -->
<div class="right-sidebar" id="rightSidebar">
  <div class="pipeline-section">
    <div class="pipeline-title">üìã Todo</div>
    <div id="todo-list"></div>
    <div class="add-btn" onclick="showAddTask()">+ Add Task</div>
  </div>
  <div class="pipeline-section">
    <div class="pipeline-title">ü§î Thinking</div>
    <div id="thinking-list"></div>
  </div>
  <div class="pipeline-section">
    <div class="pipeline-title">üîç Researching</div>
    <div id="research-list"></div>
  </div>
  <div class="pipeline-section">
    <div class="pipeline-title">üìù Reasoning 2</div>
    <div id="reasoning2-list"></div>
  </div>
  <div class="pipeline-section">
    <div class="pipeline-title">‚ö° Actions</div>
    <div id="actions-list"></div>
  </div>
  <div class="pipeline-section">
    <div class="pipeline-title">‚úÖ Summary</div>
    <div id="summary-list"></div>
  </div>
  <div class="add-btn" onclick="showFinished()">üì¶ View Finished</div>
</div>

<!-- MODALS -->
<div id="addTaskModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Add New Task</div>
    <input type="text" id="task-name" class="modal-input" placeholder="Task name..." />
    <textarea id="task-prompt" class="modal-textarea" placeholder="Describe what you want Tim to do..."></textarea>
    <div class="modal-buttons">
      <button class="modal-btn secondary" onclick="closeModal('addTaskModal')">Cancel</button>
      <button class="modal-btn primary" onclick="createTask()">Create Task</button>
    </div>
  </div>
</div>

<div id="addChatModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Create Custom Chat</div>
    <input type="text" id="chat-name" class="modal-input" placeholder="Chat name..." />
    <textarea id="chat-context" class="modal-textarea" placeholder="What is this chat for?"></textarea>
    <div class="modal-buttons">
      <button class="modal-btn secondary" onclick="closeModal('addChatModal')">Cancel</button>
      <button class="modal-btn primary" onclick="createChat()">Create</button>
    </div>
  </div>
</div>

<div id="addProjectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Create Project</div>
    <input type="text" id="project-name" class="modal-input" placeholder="Project name..." />
    <textarea id="project-context" class="modal-textarea" placeholder="Project context and information..."></textarea>
    <div class="modal-buttons">
      <button class="modal-btn secondary" onclick="closeModal('addProjectModal')">Cancel</button>
      <button class="modal-btn primary" onclick="createProject()">Create</button>
    </div>
  </div>
</div>

<div id="forceStopModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">‚ö†Ô∏è Force Stop Tim</div>
    <p style="margin-bottom:20px;color:#888;">Choose how to stop Tim:</p>
    <div class="modal-buttons" style="justify-content:center;flex-direction:column;gap:15px;">
      <button class="modal-btn primary" onclick="forceIdle()" style="width:100%;">üü° Idle Mode (2 min pause)</button>
      <button class="modal-btn danger" onclick="forceUnplug()" style="width:100%;">üî¥ Unplug (Full shutdown)</button>
      <button class="modal-btn secondary" onclick="closeModal('forceStopModal')" style="width:100%;">Cancel</button>
    </div>
  </div>
</div>

<div id="modelSwitcherModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Switch Model</div>
    <select id="model-select" class="modal-select"></select>
    <div class="modal-buttons">
      <button class="modal-btn secondary" onclick="closeModal('modelSwitcherModal')">Cancel</button>
      <button class="modal-btn primary" onclick="switchModel()">Switch Model</button>
    </div>
  </div>
</div>

<script>
const API = 'http://100.91.84.94:5000';
let currentChatId = null;
let allChats = [];
let projectType = 'normal';

async function init() {
  await loadConfig();
  await loadChats();
  await loadProjects();
  loadTasks();
  pollStatus();
}

function toggleSidebar(side) {
  const sidebar = side === 'left' ? document.getElementById('leftSidebar') : document.getElementById('rightSidebar');
  sidebar.classList.toggle('mobile-open');
}

async function loadConfig() {
  try {
    const res = await fetch(`${API}/api/config`);
    const data = await res.json();
    document.getElementById('model-name').textContent = data.model.split(':')[0];
    document.getElementById('skills-count').textContent = data.skills;
  } catch(e) {
    console.error('Config load failed:', e);
  }
}

function pollStatus() {
  setInterval(async () => {
    try {
      const res = await fetch(`${API}/api/status`);
      const data = await res.json();
      document.getElementById('status-text').textContent = data.status;
      document.getElementById('status-details').textContent = data.details || 'Ready';
    } catch(e) {}
  }, 2000);
}

async function loadChats() {
  try {
    const res = await fetch(`${API}/api/chats`);
    allChats = await res.json();
    
    const mainChat = allChats.find(c => c.type === 'main');
    if (mainChat) {
      currentChatId = mainChat.id;
      await loadMessages(mainChat.id);
    }
    
    const section = document.getElementById('chats-section');
    const items = section.querySelectorAll('.section-item');
    items.forEach(item => item.remove());
    
    allChats.forEach(chat => {
      const el = document.createElement('div');
      el.className = 'section-item';
      if (chat.id === currentChatId) el.classList.add('active');
      el.textContent = chat.type === 'main' ? 'üí¨ Main Chat' : 
                       chat.type === 'personal' ? 'üë§ Personal Chat' : 
                       `üìù ${chat.name}`;
      el.onclick = () => switchChat(chat.id, chat.name || chat.type);
      section.insertBefore(el, section.querySelector('.add-btn'));
    });
  } catch(e) {
    console.error('Chats load failed:', e);
  }
}

async function loadProjects() {
  try {
    const res = await fetch(`${API}/api/projects`);
    if (!res.ok) return;
    const projects = await res.json();
    
    ['projects-section', 'limited-projects-section'].forEach(sectionId => {
      const section = document.getElementById(sectionId);
      const items = section.querySelectorAll('.section-item');
      items.forEach(item => item.remove());
      
      const isLimited = sectionId === 'limited-projects-section';
      projects.filter(p => (isLimited && p.type === 'limited') || (!isLimited && p.type === 'normal')).forEach(project => {
        const el = document.createElement('div');
        el.className = 'section-item';
        el.textContent = `üìÅ ${project.name}`;
        el.onclick = () => alert('Project view - TODO');
        section.insertBefore(el, section.querySelector('.add-btn'));
      });
    });
  } catch(e) {}
}

async function loadTasks() {
  try {
    const res = await fetch(`${API}/api/tasks`);
    const tasks = await res.json();
    
    ['todo', 'thinking', 'research', 'reasoning2', 'actions', 'summary'].forEach(stage => {
      document.getElementById(`${stage}-list`).innerHTML = '';
    });
    
    tasks.forEach(task => {
      const el = document.createElement('div');
      el.className = 'task-item';
      el.textContent = task.name;
      
      const listId = `${task.stage}-list`;
      const list = document.getElementById(listId);
      if (list) list.appendChild(el);
    });
  } catch(e) {}
}

async function loadMessages(chatId) {
  try {
    const res = await fetch(`${API}/api/chats/${chatId}/messages`);
    const messages = await res.json();
    
    const chatArea = document.getElementById('chat-area');
    chatArea.innerHTML = '';
    
    messages.forEach(msg => {
      const m = document.createElement('div');
      m.className = `message ${msg.role === 'user' ? 'user' : 'tim'}`;
      m.textContent = msg.content;
      chatArea.appendChild(m);
    });
    
    chatArea.scrollTop = 999999;
  } catch(e) {
    console.error('Messages load failed:', e);
  }
}

function addMessage(text, isUser) {
  const m = document.createElement('div');
  m.className = `message ${isUser ? 'user' : 'tim'}`;
  m.textContent = text;
  document.getElementById('chat-area').appendChild(m);
  document.getElementById('chat-area').scrollTop = 999999;
}

async function sendMessage() {
  const input = document.getElementById('msg-input');
  const msg = input.value.trim();
  if (!msg || !currentChatId) return;
  
  addMessage(msg, true);
  input.value = '';
  
  await fetch(`${API}/api/chats/${currentChatId}/messages`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({role: 'user', content: msg})
  });
  
  try {
    const res = await fetch(`${API}/api/chat`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({message: msg})
    });
    const data = await res.json();
    
    addMessage(data.response, false);
    
    await fetch(`${API}/api/chats/${currentChatId}/messages`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({role: 'assistant', content: data.response})
    });
  } catch(e) {
    addMessage('Error connecting to Tim', false);
  }
}

async function switchChat(chatId, chatName) {
  currentChatId = chatId;
  document.getElementById('chat-header').textContent = chatName;
  await loadMessages(chatId);
  
  document.querySelectorAll('#chats-section .section-item').forEach(el => el.classList.remove('active'));
  event.target.classList.add('active');
  
  if (window.innerWidth <= 768) {
    toggleSidebar('left');
  }
}

function showAddTask() {
  document.getElementById('addTaskModal').classList.add('show');
}

async function createTask() {
  const name = document.getElementById('task-name').value;
  const prompt = document.getElementById('task-prompt').value;
  
  if (!name || !prompt) return alert('Please fill all fields');
  
  try {
    await fetch(`${API}/api/tasks`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name, prompt})
    });
    
    closeModal('addTaskModal');
    document.getElementById('task-name').value = '';
    document.getElementById('task-prompt').value = '';
    await loadTasks();
  } catch(e) {
    alert('Failed to create task');
  }
}

function showAddChat() {
  document.getElementById('addChatModal').classList.add('show');
}

async function createChat() {
  const name = document.getElementById('chat-name').value;
  const context = document.getElementById('chat-context').value;
  if (!name) return alert('Please enter a chat name');
  
  try {
    await fetch(`${API}/api/chats`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name, context})
    });
    
    closeModal('addChatModal');
    document.getElementById('chat-name').value = '';
    document.getElementById('chat-context').value = '';
    await loadChats();
  } catch(e) {
    alert('Failed to create chat');
  }
}

function showAddProject(type) {
  projectType = type;
  document.getElementById('addProjectModal').classList.add('show');
}

async function createProject() {
  const name = document.getElementById('project-name').value;
  const context = document.getElementById('project-context').value;
  if (!name) return alert('Please enter project name');
  
  try {
    await fetch(`${API}/api/projects`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name, type: projectType, context})
    });
    
    closeModal('addProjectModal');
    document.getElementById('project-name').value = '';
    document.getElementById('project-context').value = '';
    await loadProjects();
  } catch(e) {
    alert('Failed to create project');
  }
}

function showForceStopModal() {
  document.getElementById('forceStopModal').classList.add('show');
}

async function forceIdle() {
  await fetch(`${API}/api/emergency/idle`, {method: 'POST'});
  closeModal('forceStopModal');
  alert('Tim entering idle mode for 2 minutes');
}

async function forceUnplug() {
  if (!confirm('Really unplug Tim completely?')) return;
  await fetch(`${API}/api/emergency/stop`, {method: 'POST'});
  closeModal('forceStopModal');
  alert('Tim unplugged');
}

async function showModelSwitcher() {
  try {
    const res = await fetch(`${API}/api/models`);
    const models = await res.json();
    
    const select = document.getElementById('model-select');
    select.innerHTML = '';
    models.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.name;
      opt.textContent = m.name;
      select.appendChild(opt);
    });
    
    document.getElementById('modelSwitcherModal').classList.add('show');
  } catch(e) {
    alert('Failed to load models');
  }
}

async function switchModel() {
  const model = document.getElementById('model-select').value;
  if (!model) return;
  
  try {
    await fetch(`${API}/api/config/model`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({model})
    });
    
    closeModal('modelSwitcherModal');
    await loadConfig();
    alert(`Switched to ${model}`);
  } catch(e) {
    alert('Failed to switch model');
  }
}

function closeModal(id) {
  document.getElementById(id).classList.remove('show');
}

function showSkills() {
  alert('Skills:\n‚Ä¢ Chat\n‚Ä¢ Search Web\n‚Ä¢ Execute Commands\n‚Ä¢ Code Generation\n‚Ä¢ File Operations\n‚Ä¢ Memory\n‚Ä¢ Reasoning\n‚Ä¢ Task Management');
}

function showStatusDetails() {
  alert('Status details - TODO');
}

function showJournal() {
  alert('Journal - TODO');
}

function showFinished() {
  alert('Finished tasks - TODO');
}

document.getElementById('msg-input').addEventListener('keypress', e => {
  if (e.key === 'Enter') sendMessage();
});

init();
</script>
</body></html>
