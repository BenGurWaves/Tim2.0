<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üêª Tim v2.1</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:-apple-system,BlinkMacSystemFont,sans-serif; }
body { display:grid; grid-template-columns:280px 1fr 320px; height:100vh; background:#0a0a0a; color:#fff; overflow:hidden; }

.hamburger { display:none; position:fixed; top:15px; z-index:200; width:40px; height:40px; background:#222; border-radius:8px; cursor:pointer; justify-content:center; align-items:center; flex-direction:column; gap:4px; }
.hamburger.left { left:15px; }
.hamburger.right { right:15px; }
.hamburger div { width:24px; height:3px; background:#fff; }

.left-sidebar { background:#1a1a1a; padding:20px; overflow-y:auto; border-right:1px solid #333; }
.logo { font-size:20px; font-weight:700; margin-bottom:25px; }
.status-box { background:#222; padding:15px; border-radius:8px; margin-bottom:20px; }
.status-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:8px; animation:pulse 2s infinite; }
.status-dot.connected { background:#0f0; }
.status-dot.disconnected { background:#ff3333; }
@keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.3; } }
.info-row { display:flex; justify-content:space-between; margin:8px 0; font-size:13px; }
.info-label { color:#888; }
.info-value { color:#fff; font-weight:600; cursor:pointer; }
.info-value:hover { color:#0066ff; }
.section { margin-top:25px; }
.section-title { font-size:14px; font-weight:600; color:#888; margin-bottom:10px; text-transform:uppercase; }
.section-item { padding:10px; background:#222; border-radius:6px; margin-bottom:8px; cursor:pointer; font-size:14px; }
.section-item:hover { background:#2a2a2a; }
.section-item.active { background:#0066ff; }
.add-btn { padding:10px; border:2px dashed #444; border-radius:6px; text-align:center; cursor:pointer; color:#888; margin-top:8px; font-size:13px; }
.add-btn:hover { border-color:#0066ff; color:#0066ff; }
.force-stop { margin-top:30px; padding:12px; background:#ff3333; border-radius:8px; text-align:center; cursor:pointer; font-weight:600; }
.force-stop:hover { background:#ff0000; }

.center { display:flex; flex-direction:column; background:#0f0f0f; }
.chat-header { padding:15px 20px; background:#1a1a1a; border-bottom:1px solid #333; font-size:16px; font-weight:600; }
.chat-area { flex:1; padding:20px; overflow-y:auto; }
.message { padding:12px 16px; margin:10px 0; border-radius:12px; max-width:75%; font-size:14px; line-height:1.6; word-wrap:break-word; }
.message.user { background:#0066ff; margin-left:auto; }
.message.tim { background:#222; }
.input-area { padding:15px; background:#1a1a1a; border-top:1px solid #333; display:flex; gap:10px; z-index:10; }
.input-area input { flex:1; padding:12px 16px; background:#222; border:1px solid #444; border-radius:20px; color:#fff; outline:none; font-size:14px; }
.input-area button { padding:12px 24px; background:#0066ff; border:none; border-radius:20px; color:#fff; cursor:pointer; font-weight:600; min-width:80px; }
.input-area button:hover { background:#0052cc; }

.right-sidebar { background:#1a1a1a; padding:20px; overflow-y:auto; border-left:1px solid #333; }
.pipeline-section { margin-bottom:20px; }
.pipeline-title { font-size:13px; font-weight:600; color:#888; margin-bottom:10px; text-transform:uppercase; }
.task-item { padding:12px; background:#222; border-radius:6px; margin-bottom:8px; font-size:13px; cursor:pointer; }
.task-item:hover { background:#2a2a2a; }

.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2000; justify-content:center; align-items:center; }
.modal.show { display:flex; }
.modal-content { background:#1a1a1a; padding:30px; border-radius:12px; max-width:600px; width:90%; max-height:80%; overflow-y:auto; border:1px solid #333; }
.modal-header { font-size:18px; font-weight:700; margin-bottom:20px; color:#fff; }
.modal-text { color:#aaa; margin-bottom:20px; line-height:1.6; }
.modal-input { width:100%; padding:12px; background:#222; border:1px solid #444; border-radius:8px; color:#fff; margin-bottom:15px; font-size:14px; }
.modal-textarea { width:100%; min-height:150px; padding:12px; background:#222; border:1px solid #444; border-radius:8px; color:#fff; margin-bottom:15px; font-size:14px; resize:vertical; }
.modal-select { width:100%; padding:12px; background:#222; border:1px solid #444; border-radius:8px; color:#fff; margin-bottom:15px; font-size:14px; }
.modal-buttons { display:flex; gap:10px; justify-content:flex-end; margin-top:20px; flex-wrap:wrap; }
.modal-btn { padding:12px 24px; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:14px; }
.modal-btn.primary { background:#0066ff; color:#fff; }
.modal-btn.secondary { background:#333; color:#fff; }
.modal-btn.danger { background:#ff3333; color:#fff; }

@media (max-width: 768px) {
  body { grid-template-columns:1fr; }
  .left-sidebar, .right-sidebar { 
    display:none; 
    position:fixed; 
    z-index:150; 
    width:85%; 
    height:100%; 
    top:0;
  }
  .left-sidebar.mobile-open { display:block; left:0; }
  .right-sidebar.mobile-open { display:block; right:0; }
  .hamburger { display:flex; }
  .input-area { padding:12px; position:relative; z-index:10; }
  .input-area button { padding:12px 20px; }
  .message { max-width:85%; }
}
</style>
</head><body>

<div class="hamburger left" onclick="toggleSidebar('left')">
  <div></div><div></div><div></div>
</div>
<div class="hamburger right" onclick="toggleSidebar('right')">
  <div></div><div></div><div></div>
</div>

<div class="left-sidebar" id="leftSidebar">
  <div class="logo">üêª Tim v2.1</div>
  
  <div class="status-box">
    <div><span class="status-dot connected" id="status-dot"></span><span id="status-text">Connecting...</span></div>
    <div class="info-row"><span class="info-label">Details:</span><span id="status-details">Starting up</span></div>
  </div>
  
  <div class="info-row">
    <span class="info-label">Model:</span>
    <span class="info-value" id="model-name" onclick="showModelSwitcher()">Loading...</span>
  </div>
  <div class="info-row">
    <span class="info-label">Skills:</span>
    <span class="info-value" id="skills-count" onclick="showSkills()">8</span>
  </div>
  
  <div class="section" id="chats-section">
    <div class="section-title">Chats</div>
    <div class="add-btn" onclick="showAddChat()">+ Add Custom Chat</div>
  </div>
  
  <div class="section" id="projects-section">
    <div class="section-title">Projects</div>
    <div class="add-btn" onclick="showAddProject('normal')">+ New Project</div>
  </div>
  
  <div class="section" id="limited-projects-section">
    <div class="section-title">Limited Projects</div>
    <div class="add-btn" onclick="showAddProject('limited')">+ New Limited Project</div>
  </div>
  
  <div class="section">
    <div class="section-title">Journal</div>
    <div class="section-item" onclick="showJournal()">üìñ Tim's Journal</div>
  </div>
  
  <div class="force-stop" onclick="showForceStopModal()">‚ö†Ô∏è Force Stop</div>
</div>

<div class="center">
  <div class="chat-header" id="chat-header">Loading...</div>
  <div class="chat-area" id="chat-area">
    <div class="message tim">Connecting to Tim...</div>
  </div>
  <div class="input-area">
    <input type="text" id="msg-input" placeholder="Message Tim..." />
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<div class="right-sidebar" id="rightSidebar">
  <div class="pipeline-section">
    <div class="pipeline-title">üìã Todo</div>
    <div id="todo-list"></div>
    <div class="add-btn" onclick="showAddTask()">+ Add Task</div>
  </div>
  <div class="pipeline-section">
    <div class="pipeline-title">ü§î Thinking</div>
    <div id="thinking-list"></div>
  </div>
  <div class="pipeline-section">
    <div class="pipeline-title">üîç Researching</div>
    <div id="research-list"></div>
  </div>
  <div class="pipeline-section">
    <div class="pipeline-title">üìù Reasoning 2</div>
    <div id="reasoning2-list"></div>
  </div>
  <div class="pipeline-section">
    <div class="pipeline-title">‚ö° Actions</div>
    <div id="actions-list"></div>
  </div>
  <div class="pipeline-section">
    <div class="pipeline-title">‚úÖ Summary</div>
    <div id="summary-list"></div>
  </div>
  <div class="add-btn" onclick="showFinished()">üì¶ View Finished</div>
</div>

<div id="alertModal" class="modal">
  <div class="modal-content">
    <div class="modal-header" id="alert-title">Alert</div>
    <div class="modal-text" id="alert-message"></div>
    <div class="modal-buttons">
      <button class="modal-btn primary" onclick="closeModal('alertModal')">OK</button>
    </div>
  </div>
</div>

<div id="addTaskModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Add New Task</div>
    <input type="text" id="task-name" class="modal-input" placeholder="Task name..." />
    <textarea id="task-prompt" class="modal-textarea" placeholder="Describe what you want Tim to do..."></textarea>
    <div class="modal-buttons">
      <button class="modal-btn secondary" onclick="closeModal('addTaskModal')">Cancel</button>
      <button class="modal-btn primary" onclick="createTask()">Create Task</button>
    </div>
  </div>
</div>

<div id="addChatModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Create Custom Chat</div>
    <input type="text" id="chat-name" class="modal-input" placeholder="Chat name..." />
    <textarea id="chat-context" class="modal-textarea" placeholder="What is this chat for?"></textarea>
    <div class="modal-buttons">
      <button class="modal-btn secondary" onclick="closeModal('addChatModal')">Cancel</button>
      <button class="modal-btn primary" onclick="createChat()">Create</button>
    </div>
  </div>
</div>

<div id="addProjectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Create Project</div>
    <input type="text" id="project-name" class="modal-input" placeholder="Project name..." />
    <textarea id="project-context" class="modal-textarea" placeholder="Project context..."></textarea>
    <div class="modal-buttons">
      <button class="modal-btn secondary" onclick="closeModal('addProjectModal')">Cancel</button>
      <button class="modal-btn primary" onclick="createProject()">Create</button>
    </div>
  </div>
</div>

<div id="forceStopModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">‚ö†Ô∏è Force Stop Tim</div>
    <div class="modal-text">Choose how to stop Tim:</div>
    <div class="modal-buttons" style="flex-direction:column;align-items:stretch;">
      <button class="modal-btn primary" onclick="forceIdle()" style="width:100%;">üü° Idle (2 min)</button>
      <button class="modal-btn danger" onclick="forceUnplug()" style="width:100%;">üî¥ Unplug</button>
      <button class="modal-btn secondary" onclick="closeModal('forceStopModal')" style="width:100%;">Cancel</button>
    </div>
  </div>
</div>

<div id="modelSwitcherModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Switch Model</div>
    <select id="model-select" class="modal-select"></select>
    <div class="modal-buttons">
      <button class="modal-btn secondary" onclick="closeModal('modelSwitcherModal')">Cancel</button>
      <button class="modal-btn primary" onclick="switchModel()">Switch</button>
    </div>
  </div>
</div>

<script>
const API = 'http://100.91.84.94:5000';
let currentChatId = null;
let allChats = [];
let isConnected = false;
let projectType = 'normal';

function showAlert(title, message) {
  document.getElementById('alert-title').textContent = title;
  document.getElementById('alert-message').textContent = message;
  document.getElementById('alertModal').classList.add('show');
}

function toggleSidebar(side) {
  const sidebar = side === 'left' ? document.getElementById('leftSidebar') : document.getElementById('rightSidebar');
  sidebar.classList.toggle('mobile-open');
}

async function checkConnection() {
  try {
    const res = await fetch(`${API}/api/config`, { signal: AbortSignal.timeout(3000) });
    if (res.ok) {
      isConnected = true;
      document.getElementById('status-dot').className = 'status-dot connected';
      document.getElementById('status-text').textContent = 'Idle';
      document.getElementById('status-details').textContent = 'Ready';
      return true;
    }
  } catch(e) {}
  
  isConnected = false;
  document.getElementById('status-dot').className = 'status-dot disconnected';
  document.getElementById('status-text').textContent = 'Not Connected';
  document.getElementById('status-details').textContent = 'Backend offline';
  return false;
}

async function init() {
  const connected = await checkConnection();
  if (!connected) {
    document.getElementById('chat-area').innerHTML = '<div class="message tim">‚ùå Cannot connect to Tim. Make sure backend is running on your Mac.</div>';
    showAlert('Connection Error', 'Cannot reach Tim backend. Is your Mac running the server?');
    return;
  }
  
  await loadConfig();
  await loadChats();
  await loadProjects();
  await loadTasks();
  pollStatus();
}

async function loadConfig() {
  try {
    const res = await fetch(`${API}/api/config`);
    const data = await res.json();
    document.getElementById('model-name').textContent = data.model.split(':')[0];
  } catch(e) {
    console.error('Config failed:', e);
  }
}

function pollStatus() {
  setInterval(async () => {
    try {
      const res = await fetch(`${API}/api/status`, { signal: AbortSignal.timeout(2000) });
      if (res.ok) {
        const data = await res.json();
        if (!isConnected) {
          isConnected = true;
          document.getElementById('status-dot').className = 'status-dot connected';
        }
        document.getElementById('status-text').textContent = data.status;
        document.getElementById('status-details').textContent = data.details || 'Ready';
      }
    } catch(e) {
      if (isConnected) {
        isConnected = false;
        document.getElementById('status-dot').className = 'status-dot disconnected';
        document.getElementById('status-text').textContent = 'Not Connected';
        document.getElementById('status-details').textContent = 'Backend offline';
      }
    }
  }, 2000);
}

async function loadChats() {
  try {
    const res = await fetch(`${API}/api/chats`);
    allChats = await res.json();
    
    const section = document.getElementById('chats-section');
    const items = section.querySelectorAll('.section-item');
    items.forEach(item => item.remove());
    
    if (allChats.length === 0) {
      document.getElementById('chat-area').innerHTML = '<div class="message tim">No chats found. Backend may need restart.</div>';
      return;
    }
    
    const mainChat = allChats.find(c => c.type === 'main');
    if (mainChat) {
      currentChatId = mainChat.id;
      document.getElementById('chat-header').textContent = 'Main Chat';
      await loadMessages(mainChat.id);
    }
    
    allChats.forEach(chat => {
      const el = document.createElement('div');
      el.className = 'section-item';
      if (chat.id === currentChatId) el.classList.add('active');
      el.textContent = chat.type === 'main' ? 'üí¨ Main Chat' : 
                       chat.type === 'personal' ? 'üë§ Personal Chat' : 
                       `üìù ${chat.name}`;
      el.onclick = () => switchChat(chat.id, el.textContent);
      section.insertBefore(el, section.querySelector('.add-btn'));
    });
  } catch(e) {
    console.error('Chats failed:', e);
    showAlert('Error', 'Failed to load chats');
  }
}

async function loadProjects() {
  try {
    const res = await fetch(`${API}/api/projects`);
    if (!res.ok) return;
    const projects = await res.json();
    
    ['projects-section', 'limited-projects-section'].forEach(sectionId => {
      const section = document.getElementById(sectionId);
      const items = section.querySelectorAll('.section-item');
      items.forEach(item => item.remove());
      
      const isLimited = sectionId === 'limited-projects-section';
      projects.filter(p => (isLimited && p.type === 'limited') || (!isLimited && p.type === 'normal')).forEach(project => {
        const el = document.createElement('div');
        el.className = 'section-item';
        el.textContent = `üìÅ ${project.name}`;
        section.insertBefore(el, section.querySelector('.add-btn'));
      });
    });
  } catch(e) {}
}

async function loadTasks() {
  try {
    const res = await fetch(`${API}/api/tasks`);
    const tasks = await res.json();
    
    ['todo', 'thinking', 'research', 'reasoning2', 'actions', 'summary'].forEach(stage => {
      document.getElementById(`${stage}-list`).innerHTML = '';
    });
    
    tasks.forEach(task => {
      const el = document.createElement('div');
      el.className = 'task-item';
      el.textContent = task.name;
      const listId = `${task.stage}-list`;
      const list = document.getElementById(listId);
      if (list) list.appendChild(el);
    });
  } catch(e) {}
}

async function loadMessages(chatId) {
  try {
    const res = await fetch(`${API}/api/chats/${chatId}/messages`);
    const messages = await res.json();
    
    const chatArea = document.getElementById('chat-area');
    chatArea.innerHTML = '';
    
    if (messages.length === 0) {
      chatArea.innerHTML = '<div class="message tim">No messages yet. Start chatting!</div>';
      return;
    }
    
    messages.forEach(msg => {
      const m = document.createElement('div');
      m.className = `message ${msg.role === 'user' ? 'user' : 'tim'}`;
      m.textContent = msg.content;
      chatArea.appendChild(m);
    });
    
    chatArea.scrollTop = 999999;
  } catch(e) {
    console.error('Messages failed:', e);
  }
}

function addMessage(text, isUser) {
  const m = document.createElement('div');
  m.className = `message ${isUser ? 'user' : 'tim'}`;
  m.textContent = text;
  document.getElementById('chat-area').appendChild(m);
  document.getElementById('chat-area').scrollTop = 999999;
}

async function sendMessage() {
  if (!isConnected) {
    showAlert('Not Connected', 'Cannot send message. Backend is offline.');
    return;
  }
  
  const input = document.getElementById('msg-input');
  const msg = input.value.trim();
  if (!msg || !currentChatId) return;
  
  addMessage(msg, true);
  input.value = '';
  
  await fetch(`${API}/api/chats/${currentChatId}/messages`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({role: 'user', content: msg})
  });
  
  try {
    const res = await fetch(`${API}/api/chat`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({message: msg})
    });
    const data = await res.json();
    
    addMessage(data.response, false);
    
    await fetch(`${API}/api/chats/${currentChatId}/messages`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({role: 'assistant', content: data.response})
    });
  } catch(e) {
    addMessage('Error: Connection lost', false);
  }
}

async function switchChat(chatId, chatName) {
  currentChatId = chatId;
  document.getElementById('chat-header').textContent = chatName;
  await loadMessages(chatId);
  
  document.querySelectorAll('#chats-section .section-item').forEach(el => el.classList.remove('active'));
  event.target.classList.add('active');
  
  if (window.innerWidth <= 768) {
    toggleSidebar('left');
  }
}

function showAddTask() {
  document.getElementById('addTaskModal').classList.add('show');
}

async function createTask() {
  const name = document.getElementById('task-name').value.trim();
  const prompt = document.getElementById('task-prompt').value.trim();
  
  if (!name || !prompt) {
    showAlert('Missing Info', 'Please fill all fields');
    return;
  }
  
  try {
    const res = await fetch(`${API}/api/tasks`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name, prompt})
    });
    
    if (res.ok) {
      closeModal('addTaskModal');
      document.getElementById('task-name').value = '';
      document.getElementById('task-prompt').value = '';
      await loadTasks();
      showAlert('Success', 'Task created!');
    } else {
      showAlert('Error', 'Failed to create task');
    }
  } catch(e) {
    showAlert('Error', 'Connection failed');
  }
}

function showAddChat() {
  document.getElementById('addChatModal').classList.add('show');
}

async function createChat() {
  const name = document.getElementById('chat-name').value.trim();
  const context = document.getElementById('chat-context').value.trim();
  if (!name) {
    showAlert('Missing Info', 'Please enter chat name');
    return;
  }
  
  try {
    const res = await fetch(`${API}/api/chats`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name, context})
    });
    
    if (res.ok) {
      closeModal('addChatModal');
      document.getElementById('chat-name').value = '';
      document.getElementById('chat-context').value = '';
      await loadChats();
      showAlert('Success', 'Chat created!');
    } else {
      showAlert('Error', 'Failed to create chat');
    }
  } catch(e) {
    showAlert('Error', 'Connection failed');
  }
}

function showAddProject(type) {
  projectType = type;
  document.getElementById('addProjectModal').classList.add('show');
}

async function createProject() {
  const name = document.getElementById('project-name').value.trim();
  const context = document.getElementById('project-context').value.trim();
  if (!name) {
    showAlert('Missing Info', 'Please enter project name');
    return;
  }
  
  try {
    const res = await fetch(`${API}/api/projects`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name, type: projectType, context})
    });
    
    if (res.ok) {
      closeModal('addProjectModal');
      document.getElementById('project-name').value = '';
      document.getElementById('project-context').value = '';
      await loadProjects();
      showAlert('Success', 'Project created!');
    } else {
      showAlert('Error', 'Failed to create project');
    }
  } catch(e) {
    showAlert('Error', 'Connection failed');
  }
}

function showForceStopModal() {
  document.getElementById('forceStopModal').classList.add('show');
}

async function forceIdle() {
  await fetch(`${API}/api/emergency/idle`, {method: 'POST'});
  closeModal('forceStopModal');
  showAlert('Idle Mode', 'Tim entering idle for 2 minutes');
}

async function forceUnplug() {
  closeModal('forceStopModal');
  showAlert('Confirm Unplug', 'Really unplug Tim completely? This will stop all processes.');
}

async function showModelSwitcher() {
  try {
    const res = await fetch(`${API}/api/models`);
    const models = await res.json();
    
    const select = document.getElementById('model-select');
    select.innerHTML = '';
    models.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.name;
      opt.textContent = m.name;
      select.appendChild(opt);
    });
    
    document.getElementById('modelSwitcherModal').classList.add('show');
  } catch(e) {
    showAlert('Error', 'Failed to load models');
  }
}

async function switchModel() {
  const model = document.getElementById('model-select').value;
  if (!model) return;
  
  try {
    const res = await fetch(`${API}/api/config/model`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({model})
    });
    
    if (res.ok) {
      closeModal('modelSwitcherModal');
      await loadConfig();
      showAlert('Success', `Switched to ${model}`);
    } else {
      showAlert('Error', 'Failed to switch model');
    }
  } catch(e) {
    showAlert('Error', 'Connection failed');
  }
}

function closeModal(id) {
  document.getElementById(id).classList.remove('show');
}

function showSkills() {
  showAlert('Skills', 'Chat, Search Web, Execute Commands, Code Generation, File Operations, Memory, Reasoning, Task Management');
}

function showJournal() {
  showAlert('Coming Soon', 'Journal feature in development');
}

function showFinished() {
  showAlert('Coming Soon', 'Finished tasks archive in development');
}

document.getElementById('msg-input').addEventListener('keypress', e => {
  if (e.key === 'Enter') sendMessage();
});

init();
</script>
</body></html>
